# Common makefile for inclusion
#

NODE_BIN := $(CURDIR)/node_modules/.bin
BUILDDIR=cordova

VITE=$(NODE_BIN)/vite
#VITE_MODE:=production
VITE_MODE:=development
CORDOVA=$(NODE_BIN)/cordova
MAKE_CONFIG=$(NODE_BIN)/hesperian-cordova-makeconfig
MAKE_WEBINDEX=$(NODE_BIN)/hesperian-web-makeindex
MAKE_VALIDATE=$(NODE_BIN)/hesperian-validate
CORDOVA_CONFIG=$(BUILDDIR)/config.xml
VERSION := $(shell node -p "require('./app-config.json').version")
APPNAME := $(shell node -p "require('./app-config.json').name")
OUTPUT_DIR=output/${VERSION}
OUTPUT_NAME=${APPNAME}-${VERSION}
WEBAPP_DIR=./dist-web

CD_BUILDDIR= cd ${BUILDDIR}; fnm use v22.3.0

CURRENT_DIR=$(shell pwd)

.PHONY: build clean bundle watch dist help site web

help:
	@echo "Common make targets:"
	@echo "\tmake watch\t\t vite watch build in the dist directory"
	@echo "\tmake build\t\t full cordova release build created in ./output"
	@echo "\tmake ios-sync\t\t sync bundle to iOS for manual Xcode builds"
	@echo "\tmake extract_apk\t extract universal APK from AAB for emulator testing"
	@echo "\tmake test-a11y\t\t run accessibility tests (English locale)"
	@echo "\tmake test-a11y-all\t run accessibility tests (all locales)"

bundle:
	rm -rf dist
	$(VITE) build --mode=${VITE_MODE}
	${MAKE_WEBINDEX} app ./app-config.json www-templates > dist/index.html

watch:
	${MAKE_WEBINDEX} app ./app-config.json www-templates > dist/index.html
	$(VITE) build --mode=development --watch

site:
	rm -rf ${WEBAPP_DIR}
	cp -R dist ${WEBAPP_DIR}
	${MAKE_WEBINDEX} web ./app-config.json www-templates > ${WEBAPP_DIR}/index.html
	${MAKE_WEBINDEX} webembed ./app-config.json www-templates > ${WEBAPP_DIR}/embed.html
	cp -R ./node_modules/hesperian-mobile/website-common ${WEBAPP_DIR}/
	cp -R www-templates/web-img ${WEBAPP_DIR}/
	mkdir -p ${OUTPUT_DIR}
	(cd ${WEBAPP_DIR}; zip -r ../${OUTPUT_DIR}/app-${VERSION}.zip .)

dist: bundle $(CORDOVA_CONFIG)
	rm -rf ${BUILDDIR}/www
	cp -R dist ${BUILDDIR}/www

cordova-build-android:
	@(cd ${BUILDDIR}; cordova build android --device --release --verbose -- --password="${CORDOVA_SIGNING_PASSPHRASE}" --storePassword="${CORDOVA_SIGNING_PASSPHRASE}")

cordova-build: dist
	@(cd ${BUILDDIR}; fnm use v22.3.0; cordova build --device --release --verbose -- --password="${CORDOVA_SIGNING_PASSPHRASE}" --storePassword="${CORDOVA_SIGNING_PASSPHRASE}")

app: cordova-build
	mkdir -p ${OUTPUT_DIR}
	cp ${BUILDDIR}/platforms/ios/build/*/*.ipa ${OUTPUT_DIR}/${OUTPUT_NAME}.ipa
	cp ${BUILDDIR}/platforms/android/app/build/outputs/bundle/release/*.aab ${OUTPUT_DIR}/${OUTPUT_NAME}.aab

# Extract universal APK from AAB bundle for emulator testing
.PHONY: extract_apk
extract_apk:
	@if [ ! -f ${OUTPUT_DIR}/${OUTPUT_NAME}.aab ]; then \
		echo "Error: AAB file not found at ${OUTPUT_DIR}/${OUTPUT_NAME}.aab"; \
		echo "Run 'make app' first to build the AAB file."; \
		exit 1; \
	fi
	@echo "Extracting universal APK from ${OUTPUT_NAME}.aab..."
	bundletool build-apks --bundle=${OUTPUT_DIR}/${OUTPUT_NAME}.aab --output=${OUTPUT_DIR}/${OUTPUT_NAME}.apks --mode=universal
	@echo "Unzipping universal.apk..."
	unzip -o ${OUTPUT_DIR}/${OUTPUT_NAME}.apks universal.apk -d ${OUTPUT_DIR}
	mv ${OUTPUT_DIR}/universal.apk ${OUTPUT_DIR}/${OUTPUT_NAME}.apk
	rm ${OUTPUT_DIR}/${OUTPUT_NAME}.apks
	@echo "Universal APK created: ${OUTPUT_DIR}/${OUTPUT_NAME}.apk"

.PHONY: build
build: app site

# Sync bundle to iOS platform for manual Xcode builds
# Preserves cordova.js and plugin files in platforms/ios/www
.PHONY: ios-sync
ios-sync: bundle
	rm -rf ${BUILDDIR}/www
	cp -R dist ${BUILDDIR}/www
	rsync -av --delete \
		--exclude='cordova.js' \
		--exclude='cordova_plugins.js' \
		--exclude='plugins/' \
		dist/ ${BUILDDIR}/platforms/ios/www/
	@echo "✅ iOS www synced. Open ${BUILDDIR}/platforms/ios/*.xcworkspace in Xcode to build."

$(CORDOVA_CONFIG): app-config.json ${MAKE_CONFIG}
	(cd ${BUILDDIR}; rm -rf resources-tmp; ${MAKE_CONFIG} ../app-config.json)

# Make sure emulator is running to pick up correct device
# Android Studio -> Tools -> AVD's
.PHONY: emulate-android
emulate-android: dist
	@(cd ${BUILDDIR}; cordova emulate android --device --release -- --password="${CORDOVA_SIGNING_PASSPHRASE}" --storePassword="${CORDOVA_SIGNING_PASSPHRASE}")

clean:
	rm -rf ${BUILDDIR}/platforms/ios/build/
	(cd ${BUILDDIR}; cordova clean)

distclean:
	rm -rf ${BUILDDIR}/platforms/
	rm -rf ${BUILDDIR}/node_modules package-lock.json
	rm -rf ${BUILDDIR}/www ${BUILDDIR}/platforms ${BUILDDIR}/plugins

install:
	npm install
	
cordova-install: $(CORDOVA_CONFIG) bundle
	(${CD_BUILDDIR}; npm ci)
	rm -rf ${BUILDDIR}/www
	cp -R dist ${BUILDDIR}/www
	rm -rf ${BUILDDIR}/platforms
	rm -rf ${BUILDDIR}/plugins
	(${CD_BUILDDIR}; cordova prepare)





.PHONY: link
link:
	@cd ./node_modules/hesperian-mobile && npm link
	@npm link hesperian-mobile

.PHONY: example-libsync
example-libsync:
	rsync -avu --delete --exclude=node_modules --exclude=.git --exclude=example ../ ./node_modules/hesperian-mobile; chmod +x ./node_modules/.bin/*

.PHONY: validate
validate:
	${MAKE_VALIDATE}

# Accessibility Testing
.PHONY: test-a11y
test-a11y: bundle
	@( \
		set -e; \
		trap 'kill 0 2>/dev/null' EXIT; \
		echo "Starting local web server..."; \
		npx http-server ./dist -p 8080 -c-1 > /dev/null 2>&1 & \
		sleep 2; \
		echo "Running accessibility tests (English locale, all pages)..."; \
		$(NODE_BIN)/hesperian-test-accessibility; \
	)
	@echo "✅ Accessibility tests complete"

.PHONY: test-a11y-tour
test-a11y-tour: bundle
	@( \
		set -e; \
		trap 'kill 0 2>/dev/null' EXIT; \
		echo "Starting local web server..."; \
		npx http-server ./dist -p 8080 -c-1 > /dev/null 2>&1 & \
		sleep 2; \
		echo "Running accessibility tests (tour sequence)..."; \
		$(NODE_BIN)/hesperian-test-accessibility --tour=true; \
	)
	@echo "✅ Tour accessibility tests complete"

.PHONY: test-a11y-all
test-a11y-all: bundle
	@( \
		set -e; \
		trap 'kill 0 2>/dev/null' EXIT; \
		echo "Starting local web server..."; \
		npx http-server ./dist -p 8080 -c-1 > /dev/null 2>&1 & \
		sleep 2; \
		echo "Running accessibility tests (all locales, all pages)..."; \
		$(NODE_BIN)/hesperian-test-accessibility --locale=all; \
	)
	@echo "✅ Accessibility tests complete"

